<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Law Sphere</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root {
      --bg: #F1EFEC;
      --accent: #D4C9BE;
      --primary: #123458;
      --text: #030303;
      --button-bg: #123458;
      --button-text: #F1EFEC;
      --button-alt-bg: #D4C9BE;
      --button-alt-text: #123458;
    }

    html { scroll-behavior: smooth; }

    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
      overflow-x: hidden;
    }

    #main-content { position: relative; }

    .navbar {
      position: fixed;
      top: 0;
      width: 100%;
      background: rgba(241, 239, 236, 0.8);
      backdrop-filter: blur(10px);
      z-index: 1000;
      padding: 15px 0;
      border-bottom: 1px solid rgba(18, 52, 88, 0.1);
    }

    .nav-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .nav-logo {
      font-size: 1.8em;
      font-weight: 700;
      color: var(--primary);
    }

    .nav-links {
      list-style: none;
      display: flex;
      gap: 30px;
      margin: 0;
      padding: 0;
    }

    .nav-link {
      color: var(--primary);
      text-decoration: none;
      font-weight: 500;
      font-size: 1.1em;
      transition: color 0.3s ease;
    }

    .nav-link:hover,
    .nav-link.active {
      color: var(--button-alt-text);
      border-bottom: 2px solid var(--primary);
    }

    .section {
      padding: 80px 20px;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .hero-section {
      background: linear-gradient(135deg, rgba(18, 52, 88, 0.05), var(--bg));
    }

    .hero-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      width: 100%;
      gap: 40px;
    }

    .hero-title {
      font-size: 3em;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 20px;
    }

    .hero-subtitle {
      font-size: 1.2em;
      color: #666;
      line-height: 1.6;
    }

    .cta-button {
      display: inline-block;
      background: var(--button-bg);
      color: var(--button-text);
      padding: 14px 25px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      margin-top: 20px;
      transition: all 0.3s ease;
    }

    .cta-button:hover {
      background: var(--button-alt-bg);
      color: var(--button-alt-text);
      transform: scale(1.04);
    }

    .hero-image-placeholder { flex: 1; text-align: center; }

    .img-placeholder-text { font-size: 1em; color: #999; }

    .chatbot-section { background: var(--bg); }

    .chatbot-desc {
      text-align: center;
      max-width: 800px;
      margin: 0 auto 40px;
    }

    .chatbot-desc h2 {
      font-size: 2.5em;
      color: var(--primary);
      margin-bottom: 15px;
    }

    .chatbot-desc p {
      font-size: 1.1em;
      color: #666;
      line-height: 1.6;
    }

    .chatbot-interface {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 40px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .chatbot-image-placeholder { flex: 1; text-align: center; }

    .chatbot-box {
      flex: 1;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(19, 52, 88, 0.1);
      padding: 20px;
      max-width: 500px;
    }

    .chat-box {
      height: 300px;
      overflow-y: auto;
      border: 1px solid var(--accent);
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 15px;
      background: #fafafa;
    }

    .message {
      margin-bottom: 10px;
      padding: 8px 12px;
      border-radius: 6px;
      max-width: 80%;
      word-wrap: break-word;
    }

    .user-message {
      background: var(--primary);
      color: #fff;
      margin-left: auto;
      text-align: right;
    }

    .bot-message {
      background: var(--accent);
      color: var(--text);
      margin-right: auto;
    }

    .input-area {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    #user-input {
      flex: 1;
      padding: 10px;
      border: 1px solid var(--accent);
      border-radius: 6px;
      font-size: 1em;
      font-family: inherit;
    }

    #send-btn,
    #clear-chat-btn {
      background: var(--primary);
      color: white;
      padding: 10px 20px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    #clear-chat-btn {
      background: var(--button-alt-bg);
      color: var(--button-alt-text);
    }

    #send-btn:hover,
    #clear-chat-btn:hover {
      opacity: 0.9;
      transform: scale(1.02);
    }

    .login-button {
      display: block;
      width: 100%;
      background: var(--button-alt-bg);
      color: var(--primary);
      padding: 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .login-button:hover {
      background: var(--primary);
      color: var(--button-text);
    }

    .quick-questions { text-align: center; margin-top: 30px; }

    .quick-questions-title {
      font-size: 1.5em;
      color: var(--primary);
      margin-bottom: 15px;
    }

    .quick-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .quick-question {
      background: var(--accent);
      color: var(--text);
      padding: 10px 20px;
      border-radius: 20px;
      border: none;
      cursor: pointer;
      font-size: 0.9em;
      transition: all 0.3s ease;
    }

    .quick-question:hover {
      background: var(--primary);
      color: white;
    }

    .documents-section {
      background: linear-gradient(135deg, var(--bg), rgba(18, 52, 88, 0.05));
    }

    .documents-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      width: 100%;
      gap: 40px;
    }

    .documents-text { flex: 1; }

    .documents-text h2 {
      font-size: 2.5em;
      color: var(--primary);
      margin-bottom: 15px;
    }

    .documents-text p {
      font-size: 1.1em;
      color: #666;
      line-height: 1.6;
    }

    .document-actions {
      display: flex;
      gap: 15px;
      margin-top: 20px;
    }

    .doc-btn,
    .gen-btn {
      background: var(--button-bg);
      color: var(--button-text);
      padding: 14px 25px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .gen-btn {
      background: var(--button-alt-bg);
      color: var(--button-alt-text);
    }

    .doc-btn:hover,
    .gen-btn:hover {
      background: var(--button-alt-bg);
      color: var(--button-alt-text);
      transform: scale(1.04);
    }

    .documents-image-placeholder { flex: 1; text-align: center; }

    .doc-categories { max-width: 1200px; margin: 0 auto; padding: 20px; }

    .about-section { background: var(--bg); }

    .about-content {
      text-align: center;
      max-width: 800px;
      margin: 0 auto;
    }

    .about-content h2 {
      font-size: 2.5em;
      color: var(--primary);
      margin-bottom: 15px;
    }

    .about-content p {
      font-size: 1.1em;
      color: #666;
      line-height: 1.6;
      margin-bottom: 30px;
    }

    .about-image-placeholder { text-align: center; }

    #documents-browser {
      background: var(--bg);
      min-height: 100vh;
      width: 100%;
      padding: 30px 0;
      position: absolute;
      top: 0;
      left: 0;
    }

    .documents-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .document-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .document-header-actions { display: flex; gap: 10px; }

    .browse-btn,
    .generate-btn,
    .back-btn {
      background: var(--button-alt-bg);
      color: var(--primary);
      padding: 14px 25px;
      border-radius: 8px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .browse-btn.active,
    .generate-btn.active {
      background: var(--primary);
      color: var(--button-text);
    }

    .browse-btn:hover,
    .generate-btn:hover,
    .back-btn:hover {
      background: var(--primary);
      color: var(--button-text);
      transform: scale(1.04);
    }

    .category-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .category-tab {
      background: #fff;
      border: 1px solid var(--accent);
      padding: 8px 20px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .category-tab:hover,
    .category-tab.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .document-category { margin-bottom: 30px; }

    .document-category-title {
      font-size: 1.8em;
      color: var(--primary);
      margin-bottom: 15px;
    }

    .document-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
    }

    .document-item {
      background: #fff;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 12px rgba(19, 52, 88, 0.1);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .document-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(19, 52, 88, 0.15);
      background: var(--accent);
    }

    .document-title {
      font-size: 1.1em;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 5px;
    }

    .document-action { font-size: 0.9em; color: #666; }

    #document-generator {
      background: var(--bg);
      min-height: 100vh;
      width: 100%;
      padding: 30px 0;
      position: absolute;
      top: 0;
      left: 0;
    }

    .generator-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
      margin-bottom: 30px;
    }

    .generator-title {
      color: var(--primary);
      font-size: 2em;
      font-weight: 700;
    }

    .back-home-btn {
      background: var(--button-alt-bg);
      color: var(--primary);
      padding: 14px 25px;
      border-radius: 8px;
      font-weight: 600;
      min-width: 150px;
      text-align: center;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .back-home-btn:hover {
      background: var(--primary);
      color: var(--button-text);
      transform: scale(1.04);
    }

    .generator-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .generator-section { margin-bottom: 40px; }

    .generator-section h2 {
      color: var(--primary);
      font-size: 1.8em;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .generator-section p {
      color: #666;
      font-size: 1.1em;
      margin-bottom: 20px;
    }

    .template-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      padding: 10px 0;
    }

    .template-card {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 12px rgba(19, 52, 88, 0.1);
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 140px;
    }

    .template-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(19, 52, 88, 0.15);
      background: var(--accent);
    }

    .template-title {
      font-size: 1.2em;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 8px;
      overflow-wrap: break-word;
      word-break: break-word;
      max-height: 4.8em;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      line-clamp: 4;
      -webkit-line-clamp: 4;
      -webkit-box-orient: vertical;
    }

    .template-desc { font-size: 0.9em; color: #666; }

    .preview-box {
      background: #fff;
      border: 1px solid var(--accent);
      border-radius: 8px;
      padding: 20px;
      min-height: 200px;
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 20px;
    }

    .generate-btn,
    .download-btn,
    .nav-btn {
      background: var(--primary);
      color: white;
      padding: 14px 25px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      margin: 5px;
    }

    .nav-btn {
      background: var(--button-alt-bg);
      color: var(--button-alt-text);
    }

    .generate-btn:hover,
    .download-btn:hover,
    .nav-btn:hover {
      background: var(--button-alt-bg);
      color: var(--button-alt-text);
      transform: scale(1.04);
    }

    .preview-actions {
      display: flex;
      justify-content: center;
      gap: 10px;
    }

    #fill-form {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 12px rgba(19, 52, 88, 0.1);
      max-width: 600px;
      margin: 0 auto;
    }

    #fill-form label {
      display: block;
      font-weight: 500;
      color: var(--primary);
      margin-bottom: 5px;
    }

    #fill-form input,
    #fill-form textarea {
      width: 100%;
      padding: 9px;
      border: 1.5px solid var(--accent);
      border-radius: 6px;
      font-size: 1em;
      font-family: inherit;
      margin-bottom: 15px;
      box-sizing: border-box;
    }

    #fill-form button {
      background: var(--primary);
      color: white;
      padding: 14px 25px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 1.1em;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      display: block;
      margin: 0 auto;
    }

    #fill-form button:hover {
      background: var(--button-alt-bg);
      color: var(--button-alt-text);
      transform: scale(1.04);
    }

    @media (max-width: 768px) {
      .hero-content,
      .documents-content,
      .chatbot-interface {
        flex-direction: column;
        text-align: center;
      }

      .nav-links { gap: 15px; }

      .nav-link { font-size: 1em; }

      .hero-title { font-size: 2em; }

      .cta-button,
      .doc-btn,
      .gen-btn { padding: 12px 20px; }

      .document-actions { flex-direction: column; }

      .category-tabs { justify-content: center; }

      .document-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }

      .document-header-actions {
        flex-direction: column;
        width: 100%;
      }

      .browse-btn,
      .generate-btn,
      .back-btn { width: 100%; }

      .template-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div id="main-content">
    <nav class="navbar">
      <div class="nav-container">
        <div class="nav-logo">Law Sphere</div>
        <ul class="nav-links">
          <li><a href="#home" class="nav-link active">Home</a></li>
          <li><a href="#chatbot" class="nav-link">Chatbot</a></li>
          <li><a href="#documents" class="nav-link">Documents</a></li>
          <li><a href="#about" class="nav-link">About Us</a></li>
        </ul>
      </div>
    </nav>

    <section id="home" class="section hero-section">
      <div class="hero-content">
        <div>
          <h1 class="hero-title">AI-Powered Legal Assistance</h1>
          <p class="hero-subtitle">
            Empower your legal journey with instant AI advice and document automation.<br>
            Fast. Reliable. Confidential.
          </p>
          <a href="#chatbot" class="cta-button">Try the Chatbot</a>
        </div>
        <div class="hero-image-placeholder">
          <span class="img-placeholder-text"><img src="./hero.jpg" height="260px"></span>
        </div>
      </div>
    </section>

    <section id="chatbot" class="section chatbot-section">
      <div class="chatbot-desc">
        <h2>AI Legal Chatbot</h2>
        <p>
          Instantly get answers to your legal questions, draft documents, and receive guidance 24/7.<br>
          Our AI chatbot is designed to make legal help accessible and easy for everyone.
        </p>
      </div>
      <div class="chatbot-interface">
        <div class="chatbot-image-placeholder">
          <span class="img-placeholder-text"><img src="./chatbot.jpg" height="260px" width="340px"></span>
        </div>
        <div class="chatbot-box">
          <div id="chat-box" class="chat-box"></div>
          <div class="input-area">
            <input type="text" id="user-input" placeholder="Type your message..." />
            <button id="send-btn">Send</button>
            <button id="clear-chat-btn" class="clear-chat">Clear Chat</button>
          </div>
          <button id="login-button" class="login-button">Login with Google</button>
        </div>
      </div>
      <div class="quick-questions">
        <h3 class="quick-questions-title">Quick Questions:</h3>
        <div class="quick-buttons">
          <button class="quick-question" data-message="What is a contract?">What is a contract?</button>
          <button class="quick-question" data-message="How to draft a will?">How to draft a will?</button>
          <button class="quick-question" data-message="What are my tenant rights?">What are my tenant rights?</button>
          <button class="quick-question" data-message="How to file a lawsuit?">How to file a lawsuit?</button>
        </div>
      </div>
    </section>

    <section id="documents" class="section documents-section">
      <div class="documents-content">
        <div class="documents-text">
          <h2>Legal Documents & Templates</h2>
          <p>
            Instantly fetch, download, and auto-fill legal documents—from affidavits to agreements.<br>
            Save time, reduce errors, and stay compliant with our document automation tools.
          </p>
          <div class="document-actions">
            <button id="fetch-docs" class="cta-button doc-btn">Browse Documents</button>
            <button id="generate-doc" class="cta-button gen-btn">Generate Document</button>
          </div>
        </div>
        <div class="documents-image-placeholder">
          <span class="img-placeholder-text"><img src="./document.jpg" height="260px" width="340px"></span>
        </div>
      </div>
      <div id="doc-categories" class="doc-categories" style="display:none;"></div>
    </section>

    <section id="about" class="section about-section">
      <div class="about-content">
        <h2>About Law Sphere</h2>
        <p>
          Law Sphere is building the next generation of legal assistance—AI-powered, accessible, and secure.<br>
          Our mission is to democratize legal help, making it affordable and available to all.
        </p>
        <div class="about-image-placeholder">
          <span class="img-placeholder-text"><img src="./aboutus.jpg" height="200px" width="340px"></span>
        </div>
      </div>
    </section>
  </div>

  <div id="documents-browser" style="display:none;">
    <div class="documents-container">
      <div class="document-header">
        <div class="document-header-actions">
          <div class="browse-btn active">Browse Documents</div>
          <button class="generate-btn" id="generate-doc-btn">Generate Document</button>
        </div>
        <button class="back-btn" id="back-home-btn">Back to Home</button>
      </div>
      <div class="category-tabs" id="category-tabs">
        <button class="category-tab active" data-category="all">All</button>
      </div>
      <div id="document-content"></div>
    </div>
  </div>

  <div id="document-generator" style="display:none;">
    <div class="generator-header">
      <h1 class="generator-title">Document Generation</h1>
      <button class="back-home-btn" id="back-home-gen-btn">Back to Home</button>
    </div>
    <div class="generator-content">
      <div id="doc-selection" class="generator-section">
        <h2>1. Select Document</h2>
        <p>Click a document to generate a filled version based on its template.</p>
        <div class="category-tabs" id="gen-category-tabs">
          <button class="category-tab active" data-category="all">All</button>
        </div>
        <div id="gen-document-content"></div>
      </div>
      <div id="doc-fill" class="generator-section" style="display:none;">
        <h2>2. Fill Document</h2>
        <p>Preview the original template and fill in the required fields below.</p>
        <div class="preview-box" id="template-preview"></div>
        <form id="fill-form"></form>
      </div>
      <div id="doc-preview" class="generator-section" style="display:none;">
        <h2>3. Document Preview</h2>
        <p>Your document is ready. Download it below.</p>
        <div id="preview-container" class="preview-box"></div>
        <div class="preview-actions">
          <button id="download-doc" class="download-btn">Download Document</button>
          <button id="start-over-gen" class="nav-btn">Start Over</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBoiTgE744HFmOd7rFajV1k-nmsIETjOLs",
      authDomain: "law-sphere.firebaseapp.com",
      projectId: "law-sphere",
      storageBucket: "law-sphere.firebasestorage.app",
      messagingSenderId: "662426188020",
      appId: "1:662426188020:web:532de487ccfb6fe70646a1",
      measurementId: "G-SXSJBVD62M"
    };

    const BASE_URL = 'https://0d741327-a5e5-4ad9-a587-70d23bc5bb36-00-3r683pxcjo2u7.pike.replit.dev';
    const CHAT_URL = `${BASE_URL}/chat`;
    const GOOGLE_AUTH_URL = `${BASE_URL}/auth/google`;

    const mainContent = document.getElementById('main-content');
    const documentsBrowser = document.getElementById('documents-browser');
    const documentGenerator = document.getElementById('document-generator');
    const chatBox = document.getElementById('chat-box');
    const userInput = document.getElementById('user-input');
    const loginButton = document.getElementById('login-button');
    const sendBtn = document.getElementById('send-btn');
    const clearChatBtn = document.getElementById('clear-chat-btn');
    const fetchDocsBtn = document.getElementById('fetch-docs');
    const generateDocBtn = document.getElementById('generate-doc');
    const docCategories = document.getElementById('doc-categories');

    let activeCategory = 'all';
    let categoriesData = {};
    let genCategoriesData = {};
    let selectedDocument = null;

    if (!window.firebase?.apps?.length) {
      window.firebase.initializeApp(firebaseConfig);
    }
    const db = window.firebase.firestore();

    document.addEventListener('DOMContentLoaded', () => {
      sendBtn?.addEventListener('click', () => sendMessage());
      clearChatBtn?.addEventListener('click', clearChat);
      userInput?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
      });

      document.querySelectorAll('.quick-question')?.forEach(button => {
        button.addEventListener('click', () => {
          const message = button.getAttribute('data-message');
          sendMessage(message);
        });
      });

      fetchDocsBtn?.addEventListener('click', showDocumentsBrowser);
      generateDocBtn?.addEventListener('click', showDocumentGenerator);

      loginButton?.addEventListener('click', () => {
        window.location.href = GOOGLE_AUTH_URL;
      });

      document.querySelectorAll('.nav-link')?.forEach(link => {
        link.addEventListener('click', (e) => {
          const href = link.getAttribute('href');
          if (href.startsWith('#')) {
            e.preventDefault();
            document.querySelector(href).scrollIntoView({ behavior: 'smooth' });
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            link.classList.add('active');
          }
        });
      });
    });

    function sendMessage(message = userInput?.value?.trim()) {
      if (!message) return;
      addMessage(message, true);
      userInput.value = '';

      fetch(CHAT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message })
      })
        .then(response => {
          if (!response.ok) throw new Error(`Error: ${response.status}`);
          return response.json();
        })
        .then(data => {
          addMessage(data.reply || 'No response', false);
        })
        .catch(error => {
          console.error('Chat error:', error);
          addMessage('Sorry, there was an error processing your request.', false);
        });
    }

    function addMessage(text, isUser) {
      if (!chatBox) return;
      const messageDiv = document.createElement('div');
      messageDiv.className = isUser ? 'message user-message' : 'message bot-message';
      messageDiv.textContent = text;
      chatBox.appendChild(messageDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function clearChat() {
      if (chatBox) chatBox.innerHTML = '';
    }

    function showDocumentsBrowser() {
      mainContent.style.display = 'none';
      documentGenerator.style.display = 'none';
      documentsBrowser.style.display = 'block';

      const browserHTML = `
        <div class="documents-container">
          <div class="document-header">
            <div class="document-header-actions">
              <div class="browse-btn active">Browse Documents</div>
              <button class="generate-btn" id="generate-doc-btn">Generate Document</button>
            </div>
            <button class="back-btn" id="back-home-btn">Back to Home</button>
          </div>
          <div class="category-tabs" id="category-tabs">
            <button class="category-tab active" data-category="all">All</button>
          </div>
          <div id="document-content"></div>
        </div>
      `;

      documentsBrowser.innerHTML = browserHTML;

      document.getElementById('back-home-btn').addEventListener('click', backToHome);
      document.getElementById('generate-doc-btn').addEventListener('click', showDocumentGenerator);

      loadDocuments();
    }

    function backToHome() {
      documentsBrowser.style.display = 'none';
      documentGenerator.style.display = 'none';
      mainContent.style.display = 'block';
      selectedDocument = null;
    }

    function loadDocuments() {
      const documentContent = document.getElementById('document-content');
      const categoryTabs = document.getElementById('category-tabs');

      documentContent.innerHTML = '<p style="text-align: center; padding: 20px;">Loading documents...</p>';

      db.collection('legal_documents')
        .get()
        .then((querySnapshot) => {
          categoriesData = {};
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            const title = data.title;
            const displayTitle = title.replace(/\.pdf$|\.doc$/, '');
            const category = determineCategory(displayTitle, data.category);
            if (!categoriesData[category]) categoriesData[category] = [];
            categoriesData[category].push({
              title: title,
              displayTitle: displayTitle,
              url: data.url
            });
          });

          const allCategories = Object.keys(categoriesData).sort();
          allCategories.forEach(category => {
            const tab = document.createElement('button');
            tab.className = 'category-tab';
            tab.textContent = category;
            tab.dataset.category = category;
            tab.addEventListener('click', () => {
              document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
              tab.classList.add('active');
              displayDocumentsByCategory(category, documentContent);
            });
            categoryTabs.appendChild(tab);
          });

          displayDocumentsByCategory('all', documentContent);

          const totalDocs = Object.values(categoriesData).reduce((acc, docs) => acc + docs.length, 0);
          const messageElement = document.createElement('div');
          messageElement.className = 'bot-message';
          messageElement.textContent = `Fetched ${totalDocs} documents across ${allCategories.length} categories.`;
          documentContent.prepend(messageElement);
        })
        .catch((error) => {
          documentContent.innerHTML = `<p style="text-align: center; color: red; padding: 20px;">Error loading documents: ${error.message}</p>`;
          console.error('Firestore error:', error);
        });
    }

    function determineCategory(title, existingCategory) {
      const categories = {
        'Form': ['form', 'application', 'declaration', 'nomination', 'certificate', 'letter'],
        'Bank Documents': ['bank', 'account', 'nach', 'statement', 'transfer'],
        'Legal Documents': ['legal', 'affidavit', 'power of attorney', 'agreement', 'contract'],
        'Address Proof': ['address', 'residence', 'utility', 'rent']
      };
      if (existingCategory && Object.keys(categories).includes(existingCategory)) {
        return existingCategory;
      }
      const lowercaseTitle = title.toLowerCase();
      for (const [category, keywords] of Object.entries(categories)) {
        if (keywords.some(keyword => lowercaseTitle.includes(keyword))) {
          return category;
        }
      }
      return 'Miscellaneous';
    }

    function displayDocumentsByCategory(category, contentElement) {
      contentElement.innerHTML = '';
      if (category === 'all') {
        Object.entries(categoriesData).forEach(([cat, documents]) => {
          if (documents.length > 0) {
            const categoryElement = createCategoryElement(cat, documents);
            contentElement.appendChild(categoryElement);
          }
        });
      } else {
        if (categoriesData[category] && categoriesData[category].length > 0) {
          const categoryElement = createCategoryElement(category, categoriesData[category]);
          contentElement.appendChild(categoryElement);
        } else {
          contentElement.innerHTML = '<p style="text-align: center; padding: 20px;">No documents found in this category.</p>';
        }
      }
    }

    function createCategoryElement(category, documents) {
      const categoryDiv = document.createElement('div');
      categoryDiv.className = 'document-category';
      const categoryTitle = document.createElement('h2');
      categoryTitle.className = 'document-category-title';
      categoryTitle.textContent = category;
      categoryDiv.appendChild(categoryTitle);
      const documentsList = document.createElement('div');
      documentsList.className = 'document-list';
      documents.forEach(doc => {
        const docItem = document.createElement('div');
        docItem.className = 'document-item';
        docItem.innerHTML = `
          <div class="document-title">${doc.displayTitle}</div>
          <div class="document-action">Download ${doc.displayTitle}</div>
        `;
        docItem.addEventListener('click', () => downloadDocument(doc.url, doc.displayTitle));
        documentsList.appendChild(docItem);
      });
      categoryDiv.appendChild(documentsList);
      return categoryDiv;
    }

    function downloadDocument(url, filename) {
      const link = document.createElement('a');
      link.href = url;
      link.download = `${filename}.pdf`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    async function showDocumentGenerator() {
      mainContent.style.display = 'none';
      documentsBrowser.style.display = 'none';
      documentGenerator.style.display = 'block';

      const genDocumentContent = document.getElementById('gen-document-content');
      const genCategoryTabs = document.getElementById('gen-category-tabs');

      genDocumentContent.innerHTML = '<p style="text-align: center; padding: 20px;">Loading documents...</p>';

      try {
        const querySnapshot = await db.collection('legal_documents').get();
        genCategoriesData = {};

        querySnapshot.forEach((doc) => {
          const data = doc.data();
          const title = data.title;
          const displayTitle = title.replace(/\.pdf$|\.doc$/, '');
          const category = determineCategory(displayTitle, data.category);
          if (!genCategoriesData[category]) genCategoriesData[category] = [];
          genCategoriesData[category].push({
            title: title,
            displayTitle: displayTitle,
            url: data.url,
            content: data.content || ''
          });
        });

        genCategoryTabs.innerHTML = '<button class="category-tab active" data-category="all">All</button>';
        const allCategories = Object.keys(genCategoriesData).sort();
        allCategories.forEach(category => {
          const tab = document.createElement('button');
          tab.className = 'category-tab';
          tab.textContent = category;
          tab.dataset.category = category;
          tab.addEventListener('click', () => {
            document.querySelectorAll('#gen-category-tabs .category-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            displayGenDocumentsByCategory(category, genDocumentContent);
          });
          genCategoryTabs.appendChild(tab);
        });

        displayGenDocumentsByCategory('all', genDocumentContent);

        document.getElementById('back-home-gen-btn').addEventListener('click', backToHome);
      } catch (error) {
        genDocumentContent.innerHTML = `<p style="text-align: center; color: red; padding: 20px;">Error loading documents: ${error.message}</p>`;
        console.error('Firestore error:', error);
      }
    }

    function displayGenDocumentsByCategory(category, contentElement) {
      contentElement.innerHTML = '';
      const grid = document.createElement('div');
      grid.className = 'template-grid';

      if (category === 'all') {
        Object.entries(genCategoriesData).forEach(([cat, documents]) => {
          documents.forEach(doc => {
            const templateCard = createTemplateCard(doc);
            grid.appendChild(templateCard);
          });
        });
      } else if (genCategoriesData[category]) {
        genCategoriesData[category].forEach(doc => {
          const templateCard = createTemplateCard(doc);
          grid.appendChild(templateCard);
        });
      } else {
        contentElement.innerHTML = '<p style="text-align: center; padding: 20px;">No documents found in this category.</p>';
        return;
      }

      contentElement.appendChild(grid);
    }

    function createTemplateCard(doc) {
      const card = document.createElement('div');
      card.className = 'template-card';
      card.innerHTML = `
        <div class="template-title">${doc.displayTitle}</div>
        <div class="template-desc">Click to generate</div>
      `;
      card.addEventListener('click', () => selectGenDocument(doc));
      return card;
    }

    async function selectGenDocument(doc) {
      selectedDocument = doc;
      document.getElementById('doc-selection').style.display = 'none';
      document.getElementById('doc-fill').style.display = 'block';
      document.getElementById('doc-preview').style.display = 'none';

      await loadTemplateAndGenerateForm();
    }

    async function loadTemplateAndGenerateForm() {
      const templatePreview = document.getElementById('template-preview');
      const fillForm = document.getElementById('fill-form');

      if (!selectedDocument.content) {
        templatePreview.innerHTML = '<p style="color: red;">Template content not available.</p>';
        return;
      }

      templatePreview.textContent = selectedDocument.content;

      const fields = extractFieldsFromTemplate(selectedDocument.content);

      fillForm.innerHTML = '';
      fields.forEach((field, index) => {
        const label = document.createElement('label');
        label.textContent = field.label;
        const input = document.createElement(field.type === 'textarea' ? 'textarea' : 'input');
        input.id = `field-${index}`;
        input.name = field.label;
        input.required = true;
        if (field.type === 'textarea') {
          input.rows = 3;
        }
        fillForm.appendChild(label);
        fillForm.appendChild(input);
      });

      const submitButton = document.createElement('button');
      submitButton.type = 'submit';
      submitButton.textContent = 'Generate Document';
      fillForm.appendChild(submitButton);

      fillForm.addEventListener('submit', (e) => {
        e.preventDefault();
        generateDocument(fields);
      });
    }

    function extractFieldsFromTemplate(content) {
      const fields = [];
      const lines = content.split('\n');
      const fieldPatterns = [
        { pattern: /(\d+\.\s*[^:]+):\s*_+/, type: 'input' },
        { pattern: /([^:]+):\s*_+/, type: 'input' },
        { pattern: /Details of Nominee\(s\)/, type: 'textarea' }
      ];

      lines.forEach(line => {
        for (const pattern of fieldPatterns) {
          const match = line.match(pattern.pattern);
          if (match) {
            const label = match[1].trim();
            fields.push({
              label: label,
              type: pattern.type,
              placeholder: line.includes('_____') ? line.match(/_+/)[0] : null
            });
            break;
          }
        }
      });

      return fields;
    }

    function generateDocument(fields) {
      const userInputs = fields.map((field, index) => {
        const input = document.getElementById(`field-${index}`);
        return { label: field.label, value: input.value };
      });

      let filledContent = selectedDocument.content;
      userInputs.forEach(input => {
        const regex = new RegExp(`${input.label}:\\s*_+$`, 'g');
        filledContent = filledContent.replace(regex, `${input.label}: ${input.value}`);
      });

      const previewContainer = document.getElementById('preview-container');
      previewContainer.textContent = filledContent;

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const margin = 10;
      const lineHeight = 10;
      let yPosition = margin;

      const lines = filledContent.split('\n');
      doc.setFontSize(12);
      lines.forEach(line => {
        if (yPosition > 280) {
          doc.addPage();
          yPosition = margin;
        }
        doc.text(line, margin, yPosition);
        yPosition += lineHeight;
      });

      selectedDocument.pdf = doc;

      document.getElementById('doc-fill').style.display = 'none';
      document.getElementById('doc-preview').style.display = 'block';

      document.getElementById('download-doc').addEventListener('click', () => {
        selectedDocument.pdf.save(`${selectedDocument.displayTitle}-filled.pdf`);
      });

      document.getElementById('start-over-gen').addEventListener('click', () => {
        selectedDocument = null;
        document.getElementById('doc-selection').style.display = 'block';
        document.getElementById('doc-fill').style.display = 'none';
        document.getElementById('doc-preview').style.display = 'none';
        showDocumentGenerator();
      });
    }
  </script>
</body>
</html>