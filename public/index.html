<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Law Sphere</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
  <!-- Add html2pdf.js for PDF generation (as a fallback) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
  <div id="main-content">
    <!-- Transparent Navbar -->
    <nav class="navbar">
      <div class="nav-container">
        <div class="nav-logo">Law Sphere</div>
        <ul class="nav-links">
          <li><a href="#home" class="nav-link active">Home</a></li>
          <li><a href="#chatbot" class="nav-link">Chatbot</a></li>
          <li><a href="#documents" class="nav-link">Documents</a></li>
          <li><a href="#about" class="nav-link">About Us</a></li>
        </ul>
      </div>
    </nav>

    <!-- Home Section -->
    <section id="home" class="section hero-section">
      <div class="hero-content">
        <div>
          <h1 class="hero-title">AI-Powered Legal Assistance</h1>
          <p class="hero-subtitle">
            Empower your legal journey with instant AI advice and document automation.<br>
            Fast. Reliable. Confidential.
          </p>
          <a href="#chatbot" class="cta-button">Try the Chatbot</a>
        </div>
        <div class="hero-image-placeholder">
          <span class="img-placeholder-text"><img src="./hero.jpg" height="260px"></span>
        </div>
      </div>
    </section>

    <!-- Chatbot Section -->
    <section id="chatbot" class="section chatbot-section">
      <div class="chatbot-desc">
        <h2>AI Legal Chatbot</h2>
        <p>
          Instantly get answers to your legal questions, draft documents, and receive guidance 24/7.<br>
          Our AI chatbot is designed to make legal help accessible and easy for everyone.
        </p>
      </div>
      <div class="chatbot-interface">
        <div class="chatbot-image-placeholder">
          <span class="img-placeholder-text"><img src="./chatbot.jpg" height="260px" width="340px"></span>
        </div>
        <div class="chatbot-box">
          <div id="chat-box" class="chat-box"></div>
          <div class="input-area">
            <input type="text" id="user-input" placeholder="Type your message..." />
            <button id="send-btn">Send</button>
            <button id="clear-chat-btn" class="clear-chat">Clear Chat</button>
          </div>
          <button id="login-button" class="login-button">Login with Google</button>
        </div>
      </div>
      <div class="quick-questions">
        <h3 class="quick-questions-title">Quick Questions:</h3>
        <div class="quick-buttons">
          <button class="quick-question" data-message="What is a contract?">What is a contract?</button>
          <button class="quick-question" data-message="How to draft a will?">How to draft a will?</button>
          <button class="quick-question" data-message="What are my tenant rights?">What are my tenant rights?</button>
          <button class="quick-question" data-message="How to file a lawsuit?">How to file a lawsuit?</button>
        </div>
      </div>
    </section>

    <!-- Documents Section -->
    <section id="documents" class="section documents-section">
      <div class="documents-content">
        <div class="documents-text">
          <h2>Legal Documents & Templates</h2>
          <p>
            Instantly fetch, download, and auto-fill legal documents—from affidavits to agreements.<br>
            Save time, reduce errors, and stay compliant with our document automation tools.
          </p>
          <div class="document-actions">
            <button id="fetch-docs" class="cta-button doc-btn">Browse Documents</button>
            <button id="generate-doc" class="cta-button gen-btn">Generate Document</button>
          </div>
        </div>
        <div class="documents-image-placeholder">
          <span class="img-placeholder-text"><img src="./document.jpg" height="260px" width="340px"></span>
        </div>
      </div>
      <div id="doc-categories" class="doc-categories" style="display:none;"></div>
    </section>

    <!-- About Us Section -->
    <section id="about" class="section about-section">
      <div class="about-content">
        <h2>About Law Sphere</h2>
        <p>
          Law Sphere is building the next generation of legal assistance—AI-powered, accessible, and secure.<br>
          Our mission is to democratize legal help, making it affordable and available to all.
        </p>
        <div class="about-image-placeholder">
          <span class="img-placeholder-text"><img src="./aboutus.jpg" height="200px" width="340px"></span>
        </div>
      </div>
    </section>
  </div>

  <!-- Documents Browser -->
  <div id="documents-browser" style="display:none;">
    <div class="documents-container">
      <div class="document-header">
        <div class="document-header-actions">
          <div class="browse-btn active">Browse Documents</div>
          <button class="generate-btn" id="generate-doc-btn">Generate Document</button>
        </div>
        <button class="back-btn" id="back-home-btn">Back to Home</button>
      </div>
      <div class="category-tabs" id="category-tabs">
        <button class="category-tab active" data-category="all">All</button>
      </div>
      <div id="document-content"></div>
    </div>
  </div>

  <!-- Document Generator -->
  <div id="document-generator" style="display:none;">
    <div class="generator-header">
      <h1 class="generator-title">Document Generation</h1>
      <button class="back-home-btn" id="back-home-gen-btn">Back to Home</button>
    </div>
    <div class="generator-content">
      <div id="doc-selection" class="generator-section">
        <h2>1. Select Document</h2>
        <p>Click a document to generate it with AI assistance.</p>
        <div class="category-tabs" id="gen-category-tabs">
          <button class="category-tab active" data-category="all">All</button>
        </div>
        <div id="gen-document-content"></div>
      </div>
      <div id="doc-chat" class="generator-section" style="display:none;">
        <h2>2. Answer Questions</h2>
        <p>Chat with AI to fill the document. Enter your answers below.</p>
        <div id="chat-box-gen" class="chat-box-gen"></div>
        <div class="input-area-gen">
          <input type="text" id="user-input-gen" placeholder="Type your answer..." />
          <button id="send-btn-gen">Send</button>
        </div>
        <button id="generate-doc-final" class="generate-btn" style="display:none;">Generate Document</button>
      </div>
      <div id="doc-preview" class="generator-section" style="display:none;">
        <h2>3. Document Preview</h2>
        <p>Your document is ready. Download it below.</p>
        <div id="preview-container" class="preview-box"></div>
        <div class="preview-actions">
          <button id="download-doc" class="download-btn">Download Document</button>
          <button id="start-over-gen" class="nav-btn">Start Over</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase Scripts (Updated to version 10.13.2) -->
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore-compat.js"></script>

  <!-- Inline JavaScript -->
  <script>
    // ====================== Firebase Configuration ======================
    const firebaseConfig = {
      apiKey: "AIzaSyBoiTgE744HFmOd7rFajV1k-nmsIETjOLs",
      authDomain: "law-sphere.firebaseapp.com",
      projectId: "law-sphere",
      storageBucket: "law-sphere.firebasestorage.app",
      messagingSenderId: "662426188020",
      appId: "1:662426188020:web:532de487ccfb6fe70646a1",
      measurementId: "G-SXSJBVD62M"
    };

    // ====================== API Configuration ======================
    const BASE_URL = 'https://0d741327-a5e5-4ad9-a587-70d23bc5bb36-00-3r683pxcjo2u7.pike.replit.dev';
    const CHAT_URL = `${BASE_URL}/chat`;
    const GOOGLE_AUTH_URL = `${BASE_URL}/auth/google`;
    const GET_TEMPLATE_URL = `${BASE_URL}/get-document-template`;
    const GENERATE_DOCUMENT_URL = `${BASE_URL}/generate-filled-document`;

    // ====================== DOM Elements ======================
    const mainContent = document.getElementById('main-content');
    const documentsBrowser = document.getElementById('documents-browser');
    const documentGenerator = document.getElementById('document-generator');
    const chatBox = document.getElementById('chat-box');
    const userInput = document.getElementById('user-input');
    const loginButton = document.getElementById('login-button');
    const sendBtn = document.getElementById('send-btn');
    const clearChatBtn = document.getElementById('clear-chat-btn');
    const fetchDocsBtn = document.getElementById('fetch-docs');
    const generateDocBtn = document.getElementById('generate-doc');
    const docCategories = document.getElementById('doc-categories');

    // ====================== Global Variables ======================
    let activeCategory = 'all';
    let categoriesData = {};

    // Document Generator State
    let selectedDocumentTitle = null;
    let documentQuestions = [];
    let documentResponses = {};
    let currentQuestionIndex = 0;
    let documentTemplate = null; // Store the fetched template structure

    // Fallback Generic Template (if backend fails to provide a template)
    const fallbackTemplate = (title, fields) => `
      <div style="font-family: 'Poppins', sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px;">
        <h2 style="text-align: center; color: #123458; font-size: 1.5em; font-weight: 700;">
          ${title.toUpperCase()}
        </h2>
        ${fields.map(field => `
          <p style="font-size: 1em; margin: 5px 0;">
            <strong>${field.toUpperCase()}:</strong> <span id="${field}">{${field}}</span>
          </p>
        `).join('')}
      </div>
    `;

    // ====================== Firebase Initialization ======================
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    // ====================== Event Listeners ======================
    document.addEventListener('DOMContentLoaded', () => {
      sendBtn?.addEventListener('click', () => sendMessage());
      clearChatBtn?.addEventListener('click', clearChat);
      userInput?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
      });

      document.querySelectorAll('.quick-question')?.forEach(button => {
        button.addEventListener('click', () => {
          const message = button.getAttribute('data-message');
          sendMessage(message);
        });
      });

      fetchDocsBtn?.addEventListener('click', showDocumentsBrowser);
      generateDocBtn?.addEventListener('click', showDocumentGenerator);

      loginButton?.addEventListener('click', () => {
        window.location.href = GOOGLE_AUTH_URL;
      });

      document.querySelectorAll('.nav-link')?.forEach(link => {
        link.addEventListener('click', (e) => {
          const href = link.getAttribute('href');
          if (href.startsWith('#')) {
            e.preventDefault();
            document.querySelector(href).scrollIntoView({ behavior: 'smooth' });
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            link.classList.add('active');
          }
        });
      });
    });

    // ====================== Chatbot Functions ======================
    function sendMessage(message = userInput?.value?.trim()) {
      if (!message) return;
      addMessage(message, true);
      userInput.value = '';

      fetch(CHAT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message })
      })
        .then(response => {
          if (!response.ok) throw new Error(`Error: ${response.status}`);
          return response.json();
        })
        .then(data => {
          addMessage(data.reply || 'No response', false);
        })
        .catch(error => {
          console.error('Chat error:', error);
          addMessage('Sorry, there was an error processing your request.', false);
        });
    }

    function addMessage(text, isUser) {
      if (!chatBox) return;
      const messageDiv = document.createElement('div');
      messageDiv.className = isUser ? 'message user-message' : 'message bot-message';
      messageDiv.textContent = text;
      chatBox.appendChild(messageDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function clearChat() {
      if (chatBox) chatBox.innerHTML = '';
    }

    // ====================== Document Browser Functions ======================
    function showDocumentsBrowser() {
      mainContent.style.display = 'none';
      documentGenerator.style.display = 'none';
      documentsBrowser.style.display = 'block';

      const browserHTML = `
        <div class="documents-container">
          <div class="document-header">
            <div class="document-header-actions">
              <div class="browse-btn active">Browse Documents</div>
              <button class="generate-btn" id="generate-doc-btn">Generate Document</button>
            </div>
            <button class="back-btn" id="back-home-btn">Back to Home</button>
          </div>
          <div class="category-tabs" id="category-tabs">
            <button class="category-tab active" data-category="all">All</button>
          </div>
          <div id="document-content"></div>
        </div>
      `;

      documentsBrowser.innerHTML = browserHTML;

      document.getElementById('back-home-btn').addEventListener('click', backToHome);
      document.getElementById('generate-doc-btn').addEventListener('click', showDocumentGenerator);

      loadDocuments();
    }

    function backToHome() {
      documentsBrowser.style.display = 'none';
      documentGenerator.style.display = 'none';
      mainContent.style.display = 'block';
      resetDocumentGeneratorState();
    }

    function resetDocumentGeneratorState() {
      selectedDocumentTitle = null;
      documentQuestions = [];
      documentResponses = {};
      currentQuestionIndex = 0;
      documentTemplate = null;
    }

    function loadDocuments() {
      const documentContent = document.getElementById('document-content');
      const categoryTabs = document.getElementById('category-tabs');

      documentContent.innerHTML = '<p style="text-align: center; padding: 20px;">Loading documents...</p>';

      db.collection('legal_documents')
        .get()
        .then((querySnapshot) => {
          categoriesData = {};
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            const title = data.title;
            const displayTitle = title.replace(/\.pdf$|\.doc$/, '');
            const category = determineCategory(displayTitle, data.category);
            if (!categoriesData[category]) categoriesData[category] = [];
            categoriesData[category].push({
              title: title,
              displayTitle: displayTitle,
              url: data.url
            });
          });

          const allCategories = Object.keys(categoriesData).sort();
          allCategories.forEach(category => {
            const tab = document.createElement('button');
            tab.className = 'category-tab';
            tab.textContent = category;
            tab.dataset.category = category;
            tab.addEventListener('click', () => {
              document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
              tab.classList.add('active');
              displayDocumentsByCategory(category, documentContent);
            });
            categoryTabs.appendChild(tab);
          });

          displayDocumentsByCategory('all', documentContent);

          const totalDocs = Object.values(categoriesData).reduce((acc, docs) => acc + docs.length, 0);
          const messageElement = document.createElement('div');
          messageElement.className = 'bot-message';
          messageElement.textContent = `Fetched ${totalDocs} documents across ${allCategories.length} categories.`;
          documentContent.prepend(messageElement);
        })
        .catch((error) => {
          documentContent.innerHTML = `<p style="text-align: center; color: red; padding: 20px;">Error loading documents: ${error.message}</p>`;
          console.error('Firestore error:', error);
        });
    }

    function determineCategory(title, existingCategory) {
      const categories = {
        'Form': ['form', 'application', 'declaration', 'nomination', 'certificate', 'letter'],
        'Bank Documents': ['bank', 'account', 'nach', 'statement', 'transfer'],
        'Legal Documents': ['legal', 'affidavit', 'power of attorney', 'agreement', 'contract'],
        'Address Proof': ['address', 'residence', 'utility', 'rent']
      };
      if (existingCategory && Object.keys(categories).includes(existingCategory)) {
        return existingCategory;
      }
      const lowercaseTitle = title.toLowerCase();
      for (const [category, keywords] of Object.entries(categories)) {
        if (keywords.some(keyword => lowercaseTitle.includes(keyword))) {
          return category;
        }
      }
      return 'Miscellaneous';
    }

    function displayDocumentsByCategory(category, contentElement) {
      contentElement.innerHTML = '';
      if (category === 'all') {
        Object.entries(categoriesData).forEach(([cat, documents]) => {
          if (documents.length > 0) {
            const categoryElement = createCategoryElement(cat, documents);
            contentElement.appendChild(categoryElement);
          }
        });
      } else {
        if (categoriesData[category] && categoriesData[category].length > 0) {
          const categoryElement = createCategoryElement(category, categoriesData[category]); // Fixed: Use categoriesData[category]
          contentElement.appendChild(categoryElement);
        } else {
          contentElement.innerHTML = '<p style="text-align: center; padding: 20px;">No documents found in this category.</p>';
        }
      }
    }

    function createCategoryElement(category, documents) {
      const categoryDiv = document.createElement('div');
      categoryDiv.className = 'document-category';
      const categoryTitle = document.createElement('h2');
      categoryTitle.className = 'document-category-title';
      categoryTitle.textContent = category;
      categoryDiv.appendChild(categoryTitle);
      const documentsList = document.createElement('div');
      documentsList.className = 'document-list';
      documents.forEach(doc => {
        const docItem = document.createElement('div');
        docItem.className = 'document-item';
        docItem.innerHTML = `
          <div class="document-title">${doc.displayTitle}</div>
          <div class="document-action">Download ${doc.displayTitle}</div>
        `;
        docItem.addEventListener('click', () => downloadDocument(doc.url, doc.displayTitle));
        documentsList.appendChild(docItem);
      });
      categoryDiv.appendChild(documentsList);
      return categoryDiv;
    }

    function downloadDocument(url, filename) {
      const link = document.createElement('a');
      link.href = url;
      link.download = `${filename}.pdf`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // ====================== Document Generator Functions ======================
    async function showDocumentGenerator() {
      mainContent.style.display = 'none';
      documentsBrowser.style.display = 'none';
      documentGenerator.style.display = 'block';

      documentGenerator.innerHTML = `
        <div class="generator-header">
          <h1 class="generator-title">Document Generation</h1>
          <button class="back-home-btn" id="back-home-gen-btn">Back to Home</button>
        </div>
        <div class="generator-content">
          <div id="doc-selection" class="generator-section">
            <h2>1. Select Document</h2>
            <p>Click a document to generate it with AI assistance.</p>
            <div class="category-tabs" id="gen-category-tabs">
              <button class="category-tab active" data-category="all">All</button>
            </div>
            <div id="gen-document-content"></div>
          </div>
          <div id="doc-chat" class="generator-section" style="display:none;">
            <h2>2. Answer Questions</h2>
            <p>Chat with AI to fill the document. Enter your answers below.</p>
            <div id="chat-box-gen" class="chat-box-gen"></div>
            <div class="input-area-gen">
              <input type="text" id="user-input-gen" placeholder="Type your answer..." />
              <button id="send-btn-gen">Send</button>
            </div>
            <button id="generate-doc-final" class="generate-btn" style="display:none;">Generate Document</button>
          </div>
          <div id="doc-preview" class="generator-section" style="display:none;">
            <h2>3. Document Preview</h2>
            <p id="preview-message">Your document is ready. Download it below.</p>
            <div id="preview-container" class="preview-box"></div>
            <div class="preview-actions">
              <button id="download-doc" class="download-btn">Download Document</button>
              <button id="start-over-gen" class="nav-btn">Start Over</button>
            </div>
          </div>
        </div>
      `;

      document.getElementById('back-home-gen-btn').addEventListener('click', backToHome);
      await loadGenDocuments();
      setupGeneratorEventListeners();
    }

    async function loadGenDocuments() {
      const documentContent = document.getElementById('gen-document-content');
      const categoryTabs = document.getElementById('gen-category-tabs');
      documentContent.innerHTML = '<p style="text-align: center; padding: 20px;">Loading documents...</p>';
      window.genCategoriesData = {};
      try {
        const querySnapshot = await db.collection('legal_documents').get();
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          const title = data.title;
          const displayTitle = title.replace(/\.pdf$|\.doc$/, '');
          const category = determineCategory(displayTitle, data.category);
          if (!window.genCategoriesData[category]) window.genCategoriesData[category] = [];
          window.genCategoriesData[category].push({
            title: title,
            displayTitle: displayTitle,
            url: data.url
          });
        });

        categoryTabs.innerHTML = '';
        const allCategories = Object.keys(window.genCategoriesData).sort();
        allCategories.forEach(category => {
          const tab = document.createElement('button');
          tab.className = 'category-tab';
          tab.textContent = category;
          tab.dataset.category = category;
          tab.addEventListener('click', () => {
            document.querySelectorAll('#gen-category-tabs .category-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            displayGenDocumentsByCategory(category, documentContent);
          });
          categoryTabs.appendChild(tab);
        });

        const allTab = document.createElement('button');
        allTab.className = 'category-tab active';
        allTab.textContent = 'All';
        allTab.dataset.category = 'all';
        allTab.addEventListener('click', () => {
          document.querySelectorAll('#gen-category-tabs .category-tab').forEach(t => t.classList.remove('active'));
          allTab.classList.add('active');
          displayGenDocumentsByCategory('all', documentContent);
        });
        categoryTabs.prepend(allTab);

        displayGenDocumentsByCategory('all', documentContent);
      } catch (error) {
        documentContent.innerHTML = `<p style="text-align: center; color: red; padding: 20px;">Error loading documents: ${error.message}</p>`;
        console.error('Firestore error:', error);
      }
    }

    function displayGenDocumentsByCategory(category, contentElement) {
      contentElement.innerHTML = '';
      const categoriesData = window.genCategoriesData || {};
      if (category === 'all') {
        Object.entries(categoriesData).forEach(([cat, documents]) => {
          if (documents.length > 0) {
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'document-category';
            const categoryTitle = document.createElement('h2');
            categoryTitle.className = 'document-category-title';
            categoryTitle.textContent = cat;
            categoryDiv.appendChild(categoryTitle);
            const documentsList = document.createElement('div');
            documentsList.className = 'template-grid';
            documents.forEach(doc => {
              const docItem = document.createElement('div');
              docItem.className = 'template-card';
              docItem.innerHTML = `
                <div class="template-title">${doc.displayTitle}</div>
                <div class="template-desc">Click to generate</div>
              `;
              docItem.addEventListener('click', () => selectGenDocument(doc.title, doc.url));
              documentsList.appendChild(docItem);
            });
            categoryDiv.appendChild(documentsList);
            contentElement.appendChild(categoryDiv);
          }
        });
      } else {
        if (categoriesData[category] && categoriesData[category].length > 0) {
          const documentsList = document.createElement('div');
          documentsList.className = 'template-grid';
          categoriesData[category].forEach(doc => {
            const docItem = document.createElement('div');
            docItem.className = 'template-card';
            docItem.innerHTML = `
              <div class="template-title">${doc.displayTitle}</div>
              <div class="template-desc">Click to generate</div>
            `;
            docItem.addEventListener('click', () => selectGenDocument(doc.title, doc.url));
            documentsList.appendChild(docItem);
          });
          contentElement.appendChild(documentsList);
        } else {
          contentElement.innerHTML = '<p style="text-align: center; padding: 20px;">No documents found in this category.</p>';
        }
      }
    }

    async function selectGenDocument(title, url) {
      selectedDocumentTitle = title;
      document.getElementById('doc-selection').style.display = 'none';
      document.getElementById('doc-chat').style.display = 'block';
      documentQuestions = [];
      documentResponses = {};
      currentQuestionIndex = 0;
      document.getElementById('chat-box-gen').innerHTML = '';

      // Fetch the template structure from the backend
      await fetchTemplate(title, url);
      fetchQuestions();
    }

    async function fetchTemplate(title, url) {
      try {
        const response = await fetch(GET_TEMPLATE_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ documentTitle: title, documentUrl: url })
        });
        if (!response.ok) throw new Error(`Failed to fetch template: ${response.status}`);
        const data = await response.json();
        documentTemplate = data.template || null;
        documentQuestions = data.fields.map(field => ({
          question: `Please provide the ${field.label || field.name}?`,
          fieldName: field.name
        }));
      } catch (error) { // Fixed: Removed erroneous "33"
        console.error('Template fetch error:', error);
        addChatMessage(`Error: Failed to fetch template - ${error.message}`, false);
        // Fallback to a generic template
        documentTemplate = null;
        documentQuestions = [
          { question: "What is your full name?", fieldName: "fullName" },
          { question: "What is your address?", fieldName: "address" }
        ];
      }
    }

    function fetchQuestions() {
      if (documentQuestions.length === 0) {
        addChatMessage("Error: No fields available for this document.", false);
        document.getElementById('doc-chat').style.display = 'none';
        document.getElementById('doc-selection').style.display = 'block';
        return;
      }
      addChatMessage('AI: Please answer the following questions to fill the document:', false);
      addChatMessage(`AI: ${documentQuestions[currentQuestionIndex].question}`, false);
      document.getElementById('send-btn-gen').style.display = 'block';
      document.getElementById('generate-doc-final').style.display = 'none';
    }

    function addChatMessage(text, isUser) {
      const chatBox = document.getElementById('chat-box-gen');
      if (!chatBox) return;
      const messageDiv = document.createElement('div');
      messageDiv.className = isUser ? 'message user-message' : 'message bot-message';
      messageDiv.textContent = text;
      chatBox.appendChild(messageDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function sendGenMessage(message = document.getElementById('user-input-gen').value.trim()) {
      if (!message) return;
      addChatMessage(message, true);
      document.getElementById('user-input-gen').value = '';

      if (currentQuestionIndex < documentQuestions.length) {
        const currentQuestion = documentQuestions[currentQuestionIndex];
        documentResponses[currentQuestion.fieldName] = message;
        currentQuestionIndex++;
        if (currentQuestionIndex < documentQuestions.length) {
          const nextQuestion = documentQuestions[currentQuestionIndex];
          addChatMessage(`AI: ${nextQuestion.question}`, false);
        } else {
          addChatMessage('AI: All questions answered. Click "Generate Document" to proceed.', false);
          document.getElementById('generate-doc-final').style.display = 'block';
          document.getElementById('send-btn-gen').style.display = 'none';
        }
      }
    }

    async function generateDocument() {
      try {
        if (!selectedDocumentTitle) {
          throw new Error("No document selected. Please start over.");
        }
        if (Object.keys(documentResponses).length !== documentQuestions.length) {
          throw new Error("Please answer all questions before generating the document.");
        }

        let template = documentTemplate;
        let fields = documentQuestions.map(q => q.fieldName);

        // If no template was fetched, use the fallback
        if (!template) {
          template = fallbackTemplate(selectedDocumentTitle.replace(/\.pdf$|\.doc$/, ''), fields);
        }

        // Call the backend to generate the filled document
        const response = await fetch(GENERATE_DOCUMENT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            documentTitle: selectedDocumentTitle,
            responses: documentResponses,
            template: template
          })
        });

        if (!response.ok) throw new Error(`Failed to generate document: ${response.status}`);
        const data = await response.json();

        // Display the filled template in the preview
        document.getElementById('doc-chat').style.display = 'none';
        document.getElementById('doc-preview').style.display = 'block';
        document.getElementById('preview-container').innerHTML = data.documentContent;

        // Update the preview message with success feedback
        document.getElementById('preview-message').textContent = `Document generated successfully. ${
          data.documentId ? `Stored with ID: ${data.documentId}.` : ''
        } Download it below.`;

        // Store the pdfBase64 for downloading
        window.generatedPdfBase64 = data.pdfBase64;

      } catch (error) {
        console.error('Document generation error:', error);
        addChatMessage(`Error: ${error.message}`, false);
        document.getElementById('doc-chat').style.display = 'none';
        document.getElementById('doc-selection').style.display = 'block';
      }
    }

    function setupGeneratorEventListeners() {
      document.getElementById('download-doc')?.addEventListener('click', () => {
        if (window.generatedPdfBase64) {
          // Download the PDF from the backend-generated Base64
          const link = document.createElement('a');
          link.href = `data:application/pdf;base64,${window.generatedPdfBase64}`;
          link.download = `${selectedDocumentTitle.replace(/\.pdf$|\.doc$/, '')}.pdf`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        } else {
          // Fallback to client-side PDF generation using html2pdf.js
          const element = document.getElementById('preview-container');
          const opt = {
            margin: 0.5,
            filename: `${selectedDocumentTitle.replace(/\.pdf$|\.doc$/, '')}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
          };
          html2pdf().set(opt).from(element).save();
        }
      });

      document.getElementById('start-over-gen')?.addEventListener('click', () => {
        resetDocumentGeneratorState();
        window.generatedPdfBase64 = null; // Clear the stored Base64
        document.getElementById('doc-selection').style.display = 'block';
        document.getElementById('doc-chat').style.display = 'none';
        document.getElementById('doc-preview').style.display = 'none';
        loadGenDocuments();
      });

      document.getElementById('send-btn-gen')?.addEventListener('click', () => sendGenMessage());
      document.getElementById('user-input-gen')?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendGenMessage();
      });
      document.getElementById('generate-doc-final')?.addEventListener('click', generateDocument);
    }
  </script>
</body>
</html>